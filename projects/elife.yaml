defaults:
    description: defaults for all projects in this file
    salt: '2017.7.5' # the version of salt these project use
    # use false with a subdomain to assign internal addresses only
    domain: elifesciences.org
    # addressing within VPC
    intdomain: elife.internal
    # 'lax', 'metrics', 'gateway', etc
    subdomain: null
    # projects with an explicit `repo` attribute support branch deployments with
    # ./bldr deploy
    repo: null
    # repository containing build instructions for this project
    formula-repo: null
    # repo containing project pillar data (credentials typically)
    # only the master-server will have a copy of this and only the master-server
    # will need permissions to clone it
    # TODO: hunt down ssh:// remotes
    private-repo: git@github.com:elifesciences/builder-private
    configuration-repo: git@github.com:elifesciences/builder-configuration
    # default branch to use when creating new instances
    default-branch: master
    # in rare cases we have formulas requiring the states of other formulas
    formula-dependencies:
        - https://github.com/elifesciences/builder-base-formula
    aws:
        account_id: 512686554592
        # TODO: this field will become a dictionary of all EC2-related configuration
        ec2:
            # how many EC2 instance per stack instance
            cluster-size: 1
            # whether the EC2 nodes should get a per-node internal DNS entry such as env--project--1.elife.internal
            # only makes sense if cluster-size > 1
            dns-internal: False
            # override 'ext' (only supported key)
            # for some EC2 instances
            overrides: {}
            # destroy some EC2 instances in the cluster,
            # for future re-creation
            suppressed: []
            # find more here: http://cloud-images.ubuntu.com/releases/
            ami: ami-14a1d06e # GENERATED created from basebox--1604
                              # us-east-1, build date 20170811, hvm:ebs-ssd, AMI built on 20171215
            # deprecated. all projects have 16.04 support now. explicit trusty images
            # are being used until each project is running 16.04 in production
            # ami: ami-92002785   # elife 'basebox.2016-11-03'
            # use a master server or go ronin?
            masterless: false
            # optional: pin a master server for all new instances of a project
            master_ip: 10.0.2.198
            # optional: specify `ports` to be opened
            security-group: {}
        region: us-east-1
        vpc-id: vpc-78a2071d  # vpc-id + subnet-id are peculiar to AWS account + region
        subnet-id: subnet-1d4eb46a # elife-public-subnet, us-east-1d
        subnet-cidr: '10.0.2.0/24'
        ## additional value in case of capacity problems: elife-public-subnet-3, us-east-1a
        # subnet-id: subnet-2116727b
        # subnet-cidr: '10.0.10.0/24'
        # necessary for multiple-node EC2 and for ELB
        redundant-subnet-id: subnet-7a31dd46 # elife-public-subnet-2, us-east-1e
        redundant-subnet-cidr: '10.0.3.0/24'
        # TODO: this will be moved inside aws.ec2
        type: t2.small  # ~ $20/mo
        # TODO: this will be moved inside aws.ec2
        # ports: {}
        rds:
            # rds defaults only used if an `rds` section present in project
            # explicit database name overrides the one generated at template creation
            multi-az: false
            engine: postgres # or 'MySQL'
            # ensure this matches the version of Postgres you install on server!
            version: '9.4'
            type: db.t2.small
            storage: 5 # GB
            # Standard for backward compatibility
            storage-type: Standard # standard|gp2|io1 https://docs.aws.amazon.com/AmazonRDS/latest/APIReference/API_CreateDBInstance.html
            backup-retention: 28 # days
            # if rds.params are specified, a custom db parameter group is created
            params: []
            encryption: false
            # two subnets are required in two different availability zones
            # http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-rds-dbsubnet-group.html
            subnets:
                # two are required
                # NOTE! the 'dbsubnet-' prefix is important to *builder*
                # it tells us which subnets we can provision RDS within
                - subnet-8eea67d7 # elife-dbsubnet-1
                - subnet-dbc471f0 # elife-dbsubnet-2
            deletion-policy: Snapshot

        # TODO: this will be moved inside aws.ec2
        ext:
            # external hdd
            type: standard # magnetic, use 'gp2' for ssd
            size: 10 # GB
            device: /dev/sdh
        elb:
            # elb defaults only used if an 'elb' section present in project
            stickiness: false
            protocol: http
            additional_listeners: {}
            idle_timeout: 60
            # maintained through `aws iam upload-server-certificate`
            certificate: arn:aws:iam::512686554592:server-certificate/cloudfront/wildcard.elifesciences.org/wildcard.elifesciences.org
            healthcheck:
                protocol: http
                port: 80
                path: /ping
                timeout: 4 
                interval: 5
                unhealthy_threshold: 2
                healthy_threshold: 2
        sqs: []
        sns: []
        # e.g.
        # s3:
        #    bucket-name-{instance}:
        #       sqs-notifications: # not implemented
        #           queue-name:
        #               prefix: 'elife-'
        #               suffix: '.xml'
        #       deletion-policy: delete|retain
        #       encryption: false
        s3: {}
        cloudfront: 
            # cloudfront defaults only used if a 'cloudfront' section present in project
            subdomains: []
            subdomains-without-dns: []
            domains: []
            origins: {}
            # maintained through `aws iam upload-server-certificate`
            certificate_id: ASCAIRXYIRFBOR5QSDP5M
            cookies: []
            compress: true
            headers: []
            errors: null
            default-ttl: 0 # seconds
            logging: false
        fastly:
            # fastly defaults only used if a 'fastly' section present in project
            subdomains: []
            subdomains-without-dns: []
            default-ttl: 3600 # Fastly default, in seconds
            shield: true
            dns:
                cname: u2.shared.global.fastly.net
                a:
                    - 151.101.2.217
                    - 151.101.66.217
                    - 151.101.130.217
                    - 151.101.194.217
            gcslogging: false
            bigquerylogging: false
            healthcheck: false
            errors: false
            vcl:
                - "original-host"
            surrogate-keys: {}
        subdomains: []
        elasticache:
            # elasticache defaults only used if an `rds` section present in project
            type: cache.t2.small # 1.55 GB of memory, ~$25/mo
            engine: redis
            az: us-east-1d # alternative: us-east-1e to match EC2 instances
            subnets:
                - subnet-20275c68 # elife-cache-subnet-1
                - subnet-c4033af8 # elife-cache-subnet-2
            version: "2.8.24" # closest to builder-base-formula redis.sls
            configuration:
                maxmemory-policy: volatile-lru
            clusters: 1
        vault:
            address: https://master-server.elifesciences.org:8200
    aws-alt:
        fresh:
            description: uses a plain Ubuntu basebox instead of an ami
            ec2:
                ami: ami-1d4e7a66 # Ubuntu 16.04 (Xenial), us-east-1, build date 20170811, hvm:ebs-ssd
        1604:
            description: uses Ubuntu 16.04 (Xenial) instead of 14.04 (Trusty)
            ec2:
                ami: ami-14a1d06e # GENERATED created from basebox--1604
                                  # us-east-1, build date 20170811, hvm:ebs-ssd, AMI built on 20171215
        1404:
            description: uses Ubuntu 14.04 (Trusty) instead of 16.04 (Xenial)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
        standalone1604:
            description: isolated from the master-server and uses Ubuntu 16.04 (Xenial)
            ec2:
                ami: ami-14a1d06e # GENERATED created from basebox--1604
                                  # us-east-1, build date 20170811, hvm:ebs-ssd, AMI built on 20171215
                masterless: true
        standalone1404:
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            type: t2.small
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        standalone:
            description: isolated from the master-server and uses Ubuntu 16.04 (Xenial)
            ec2:
                ami: ami-14a1d06e # GENERATED created from basebox--1604
                                  # us-east-1, build date 20170811, hvm:ebs-ssd, AMI built on 20171215
                masterless: true
        standalone1804:
            description: isolated from the master-server and uses Ubuntu 18.04 (Bionic)
            ec2:
                ami: ami-075f3428d35dd9b46 # GENERATED created from basebox--1804
                                           # us-east-1, build date 20180814, hvm:ebs-ssd, AMI built on 20180828
                masterless: true
    gcp:
        bigquery: false
    vagrant:
        # why 'bento'? https://bugs.launchpad.net/cloud-images/+bug/1569237
        box: bento/ubuntu-16.04 # Ubuntu 16.04 "Xenial"
        # deprecated. all projects have 16.04 support now. explicit trusty images
        # are being used until each project is running 16.04 in production
        #box: ubuntu/trusty64 # Ubuntu 14.04
        # box-url not needed for boxes hosted on Atlas
        box-url: null
        ip: 192.168.33.44
        ram: 1024
        cpus: 2
        cpucap: 100 # percent (vagrant default)
        #ports:
        #    1239: 80
        #    1240: 8001

basebox:
    salt: '2017.7.7' # overridden for 18.04 support
    formula-repo: https://github.com/elifesciences/basebox-formula
    aws:
        ec2:
            ami: ami-9eaa1cf6 # Ubuntu 14.04 (correct, but older)
        ports:
            - 22
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        1604:
            ec2:
                ami: ami-1d4e7a66 # xenial, build 20170811, hvm:ebs-ssd
        1804:
            ec2:
                ami: ami-0b425589c7bb7663d # bionic, build 20180814, hvm:ebs-ssd
        standalone1604:
            description: isolated from the master-server and uses Ubuntu 16.04 (Xenial)
            ec2:
                ami: ami-1d4e7a66 # xenial, build 20170811, hvm:ebs-ssd
                masterless: true
    vagrant:
        box: bento/ubuntu-18.04 # Ubuntu 18.04

heavybox:
    salt: '2017.7.7' # overridden for 18.04 support
    description: builds as many of the builder-base-formula states as possible
    formula-repo: https://github.com/elifesciences/heavybox-formula
    aws:
        ports:
            - 22
        ext:
            size: 10 # GB
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
    vagrant:
        # disabled until supported
        #box: bento/ubuntu-18.04 # Ubuntu 18.04
        ram: 2048

master-server:
    subdomain: master-server
    # formula-repo for the 'master-server' project should contain the
    # confidential pillar data, master config and state top file.
    # see: https://github.com/elifesciences/builder-private
    formula-repo: https://github.com/elifesciences/master-server-formula
    aws:
        ec2: {}
        ports:
            - 22
            - 4506: # salt publish port
                # CIDR of subnet this master will server
                cidr-ip: 10.0.0.0/16 # access via VPC ip range only
            - 4505: # salt return port
                cidr-ip: 10.0.0.0/16
            - 8080 # chemist, Github webhooks for formulas
            - 8200 # Vault, secrets management
    aws-alt:
        '2018-04-09-2':
            subdomains:
                - master-server
    vagrant: {}

lax:
    description: article-json store
    subdomain: lax # lax.elifesciences.org
    intdomain: False
    repo: https://github.com/elifesciences/lax.git
    formula-repo: https://github.com/elifesciences/lax-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 443
            - 80:
                cidr-ip: 10.0.0.0/16 # internal access only
            - 8001 # bot-lax api
        sqs:
            bot-lax-{instance}-inc: {}
            bot-lax-{instance}-out: {}
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        standalone1404:
            rds:
                storage: 5
                deletion-policy: Delete
        end2end:
            description: production-like
            ec2:
                cluster-size: 2
            rds:
                storage: 5
                backup-retention: 2 # days
            ext:
                size: 10 # GB
            elb:
                protocol:
                    - https
                additional_listeners:
                    bot_lax_adaptor:
                        protocol: https
                        port: 8001
                healthcheck:
                    path: /api/v2/ping
        prod:
            description: RDS backed
            ec2:
                cluster-size: 2
            rds:
                storage: 5
                multi-az: true
            ext:
                size: 10 # GB
            elb:
                protocol:
                    - https
                additional_listeners:
                    bot_lax_adaptor:
                        protocol: https
                        port: 8001
                healthcheck:
                    path: /api/v2/ping
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1239: 80
            1240: 8001

api-gateway:
    subdomain: gateway # ll: gateway.elifesciences.org
    formula-repo: https://github.com/elifesciences/api-gateway-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            # only internal traffic has access to port 80 and http
            - 80:
                cidr-ip: 10.0.0.0/16
            # the world must use https
            - 443
            # - 8000: # don't expose this to public. Kong uses this to proxy requests
            # - 8001: # don't ever expose to public. Kong uses this for API admin
        fastly:
            subdomains:
                - "{instance}--cdn-gateway"
            healthcheck:
                path: /ping-fastly
                check-interval: 10000
                timeout: 2000
            vcl:
                - "original-host"
                - "gzip-by-content-type-suffix"
            gcslogging:
                bucket: "{instance}-elife-fastly"
                path: "api-gateway--{instance}/"
                period: 600
            bigquerylogging:
                project: "elife-fastly"
                dataset: "{instance}"
                table: "api_gateway"
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
            fastly: false
        end2end: {}
        continuumtest:
            fastly:
                bigquerylogging:
                    dataset: staging
                gcslogging:
                    bucket: staging-elife-fastly
        prod:
            fastly:
                subdomains:
                    - "{instance}--cdn-gateway"
                    - api
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1323: 80

journal:
    subdomain: journal # journal.elifesciences.org
    intdomain: null
    repo: https://github.com/elifesciences/journal
    formula-repo: https://github.com/elifesciences/journal-formula
    formula-dependencies:
        - https://github.com/elifesciences/builder-base-formula
        - https://github.com/elifesciences/api-dummy-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 443
            - 80:
                cidr-ip: 10.0.0.0/16 # access via VPC ip range only
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        ci:
            #type: t2.2xlarge
            type: c4.2xlarge
            ports:
                - 22
                - 443
        end2end:
            description: end2end environment for journal. ELB on top of multiple EC2 instances
            ec2:
                cluster-size: 2
            elasticache:
                engine: redis
                clusters: 2
                overrides:
                    2:
                        type: cache.t2.micro
            elb:
                protocol:
                    - https
                    - http
            fastly:
                subdomains:
                    - "{instance}--cdn-journal"
                healthcheck:
                    path: /ping-fastly
                    check-interval: 10000
                    timeout: 2000
                errors:
                    # always prod for simplicity
                    url: https://prod-elife-error-pages.s3.amazonaws.com/
                    codes:
                        404: "404.html"
                        410: "410.html"
                        503: "503.html"
                    fallbacks:
                        4xx: "4xx.html"
                        5xx: "5xx.html"
                vcl:
                    - "original-host"
                    - "ping-status"
                    - "strip-non-journal-cookies"
                    - "journal-google-scholar"
                    - "journal-google-scholar-vary"
                gcslogging:
                    bucket: "{instance}-elife-fastly"
                    path: "journal--{instance}/"
                    period: 600
                bigquerylogging:
                    project: "elife-fastly"
                    dataset: "{instance}"
                    table: "journal"
        continuumtest:
            elasticache:
                engine: redis
                type: cache.t2.micro
                clusters: 2
            elb:
                protocol:
                    - https
                    - http
            fastly:
                subdomains:
                    - "{instance}--cdn-journal"
                healthcheck:
                    path: /ping-fastly
                    check-interval: 10000
                    timeout: 2000
                errors:
                    # always prod for simplicity
                    url: https://prod-elife-error-pages.s3.amazonaws.com/
                    codes:
                        404: "404.html"
                        410: "410.html"
                        503: "503.html"
                    fallbacks:
                        4xx: "4xx.html"
                        5xx: "5xx.html"
                vcl:
                    - "original-host"
                    - "ping-status"
                    - "strip-non-journal-cookies"
                    - "journal-google-scholar"
                    - "journal-google-scholar-vary"
                gcslogging:
                    bucket: staging-elife-fastly
                    path: "journal--{instance}/"
                    period: 600
                bigquerylogging:
                    project: "elife-fastly"
                    dataset: "staging"
                    table: "journal"
        prod:
            description: prod environment for journal. ELB on top of multiple EC2 instances
            ec2:
                cluster-size: 3
            elasticache:
                engine: redis
                type: cache.t2.medium # 3.22 GB of memory, ~$50/mo
                clusters: 2
                overrides:
                    2:
                        type: cache.t2.micro # 0.56 GB of memory, ~$12/mo
            elb:
                protocol:
                    - https
                    - http
            cloudfront:
                subdomains:
                    - "placeholder2-prod-journal" # only here to avoid rewriting the following values
                    - www
                    - elife
                    - prod
                headers:
                    - Host
                errors:
                    domain: prod-elife-error-pages.s3-website-us-east-1.amazonaws.com
                    pattern: "???.html"
                    codes:
                        # ELB with no active instances
                        503: "/5xx.html"
                    protocol: http
            fastly:
                subdomains:
                    - "{instance}--cdn-journal"
                    - "placeholder-prod-journal" # only here to avoid rewriting the following values
                    - ""
                healthcheck:
                    path: /ping-fastly
                    check-interval: 10000
                    timeout: 2000
                errors:
                    # always prod for simplicity
                    url: https://prod-elife-error-pages.s3.amazonaws.com/
                    codes:
                        404: "404.html"
                        410: "410.html"
                        503: "503.html"
                    fallbacks:
                        4xx: "4xx.html"
                        5xx: "5xx.html"
                vcl:
                    - "original-host"
                    - "ping-status"
                    - "strip-non-journal-cookies"
                    - "journal-google-scholar"
                    - "journal-google-scholar-vary"
                gcslogging:
                    bucket: "{instance}-elife-fastly"
                    path: "journal--{instance}/"
                    period: 600
                bigquerylogging:
                    project: "elife-fastly"
                    dataset: "{instance}"
                    table: "journal"
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 4096
        ports:
            1240: 80

pattern-library:
    subdomain: ui-patterns
    repo: https://github.com/elifesciences/pattern-library
    formula-repo: https://github.com/elifesciences/pattern-library-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.small
        ports:
            - 22
            - 80
            - 443
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        ci:
            ec2: false
            s3:
                "{instance}-pattern-library":
                    public: true
        prod:
            subdomains:
                - ui-patterns
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048
        ports:
            1340: 80

evanthia-prototype:
    subdomain: evanthia-prototype
    repo: https://github.com/code56/node_web_server
    formula-repo: https://github.com/code56/node-web-server-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.small
        ports:
            - 22
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048
        ports:
            1340: 80


elife-metrics:
    description: journal-level metrics
    subdomain: metrics # metrics.elifesciences.org
    repo: https://github.com/elifesciences/elife-metrics
    formula-repo: https://github.com/elifesciences/elife-metrics-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 443
            - 80
            - 5432
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        end2end:
            description: end2end environment for metrics. RDS backed
            rds:
                backup-retention: 2 # days
        prod:
            description: production environment for metrics. RDS backed
            rds:
                multi-az: true
                storage: 10
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1240: 80


elife-bot:
    repo: https://github.com/elifesciences/elife-bot
    formula-repo: https://github.com/elifesciences/elife-bot-formula
    subdomain: bot
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.medium
        ports:
            - 22
            # TODO: close this port to outside the VPC
            - 80
        ext:
            size: 30 # GB
        s3:
            "{instance}-elife-silent-corrections":
            "{instance}-elife-published":
                deletion-policy: retain
                public: true
                cors: true
            "{instance}-elife-bot-sessions":
            "{instance}-elife-bot-digests-input":
        sns:
            # elife-bot-event-property--prod, elife-bot-event-property--end2end, etc.
            - elife-bot-event-property--{instance}
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
            s3:
                "{instance}-elife-silent-corrections":
                    deletion-policy: delete
                "{instance}-elife-published":
                    deletion-policy: delete
                "{instance}-elife-bot-sessions":
                    deletion-policy: delete
                "{instance}-elife-bot-digests-input":
                    deletion-policy: delete
                # commented out because buckets already exist outside of CloudFormation:
                #"{instance}-elife-bot":
                #    deletion-policy: delete
        end2end:
            ports:
                - 22
                - 8020 # exposing FTP contents
                - 8021 # exposing FTP contents, HTTPS
                - 1080 # exposing mailcatcher API
            description: speeding up end2end tests
            s3:
                "{instance}-elife-silent-corrections":
                    sqs-notifications:
                        end2end-incoming-queue: {}
                "{instance}-elife-bot-digests-input":
                    sqs-notifications:
                        end2end-incoming-queue: {}
            #    end2end-elife-production-final:
            #        sqs-notifications:
            #            end2end-incoming-queue: {}
            #               #prefix: null
            #               #suffix: null
        continuumtest:
            s3:
                "{instance}-elife-silent-corrections":
                    sqs-notifications:
                        ct-incoming-queue: {}
                "{instance}-elife-bot-digests-input":
                    sqs-notifications:
                        ct-incoming-queue: {}
                "{instance}-elife-bot":
                    deletion-policy: delete
        prod:
            # don't change type through CloudFormation because the template is too old to be modified successfully
            #type: c5.2xlarge
            s3:
                "{instance}-elife-silent-corrections":
                    sqs-notifications:
                        incoming-queue: {}
                "{instance}-elife-bot-digests-input":
                    sqs-notifications:
                        incoming-queue: {}
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048

generic-cdn:
    description: generic CDN for content like PDF, images
    default-branch: null
    intdomain: null
    aws:
        ec2: false
        fastly:
            subdomains:
                - "{instance}-cdn"
            backends:
                # first is default
                default:
                    hostname: elife-cdn.s3.amazonaws.com
                articles:
                    hostname: "{instance}-elife-published.s3.amazonaws.com"
                    condition: req.url ~ "^/articles/"
            default-ttl: 86400 # seconds
            vcl:
                - "original-host"
                - "office-webdav-200"
            surrogate-keys:
                article-versioned-assets:
                    url: "^/articles/([0-9]+)/elife-([a-z-0-9]+)-v([0-9]+)\\.(.+)$"
                    value: "article/\\1 article/\\1v\\3"
                    samples:
                        article-asset:
                            path: /articles/10627/elife-10627-fig1-v1.tif
                            expected: "article/10627 article/10627v1"
                        article-pdf:
                            path: /articles/10627/elife-10627-v1.pdf
                            expected: "article/10627 article/10627v1"
                        article-figures-pdf:
                            path: /articles/00666/elife-00666-figures-v1.pdf
                            expected: "article/00666 article/00666v1"
                        article-figure-supplement:
                            path: /articles/00666/elife-00666-fig2-figsupp1-v1.tif
                            expected: "article/00666 article/00666v1"
                        appendix-figure-supplement:
                            path: /articles/18215/elife-18215-app2-fig1-figsupp2-v2.tif
                            expected: "article/18215 article/18215v2"
                        # legacy, not supported: /articles/10627/elife-10627-fig1-v1-download.jpg
                        # legacy, not supported: /articles/10627/elife-10627-fig1-v1-972w.jpg
                article-unversioned:
                    url: "^/articles/([0-9]+)/elife-([a-z-0-9]+)-(video|media)([0-9]+)\\.(.+)$"
                    value: "article/\\1 article/\\1/videos"
                    samples:
                        article-video:
                            path: /articles/34773/elife-34773-video2.mp4
                            expected: "article/34773 article/34773/videos"
                        article-still:
                            path: /articles/07398/elife-07398-media1.jpg
                            expected: "article/07398 article/07398/videos"
                        article-figure-video:
                            path: /articles/26866/elife-26866-fig3-video1.mp4
                            expected: "article/26866 article/26866/videos"
            bigquerylogging:
                project: "elife-fastly"
                dataset: "{instance}"
                table: "generic_cdn"
    aws-alt:
        # have to specify this because otherwise configuration such as `fresh` inherited from defaults won't see the ec2: false in `aws:` and test_validation.py will fail for all of them?
        fresh:
            ec2: false
        1604:
            ec2: false
        1404:
            ec2: false
        standalone1604:
            ec2: false
        standalone1404:
            ec2: false
        standalone:
            ec2: false
        end2end:
            fastly:
                gcslogging:
                    bucket: end2end-elife-fastly
                    path: generic-cdn--end2end/
                    period: 600
        continuumtest:
            fastly:
                gcslogging:
                    bucket: staging-elife-fastly
                    path: generic-cdn--continuumtest/
                    period: 600
                bigquerylogging:
                    dataset: "staging"
        prod:
            fastly:
                subdomains:
                    - "cdn"
                gcslogging:
                    bucket: prod-elife-fastly
                    path: generic-cdn--prod/
                    period: 600

journal-cms:
    subdomain: journal-cms # journal-cms.elifesciences.org
    repo: https://github.com/elifesciences/journal-cms
    formula-repo: https://github.com/elifesciences/journal-cms-formula
    formula-dependencies:
        - https://github.com/elifesciences/builder-base-formula
        - https://github.com/elifesciences/api-dummy-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.small # explicitly 2GB RAM
        ports:
            - 22
            - 443
            - 80:
                cidr-ip: 10.0.0.0/16 # access via VPC ip range only
        sqs:
            # journal-cms--prod, journal-cms--end2end, etc.
            journal-cms--{instance}:
                subscriptions:
                    - bus-articles--{instance}
                    - bus-digests--{instance}
                    - bus-metrics--{instance}
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        ckeditor:
            description: testing environment. backed by RDS
            ext:
                size: 10 # GB
        ci:
            ext:
                size: 5 # GB
        end2end:
            description: production-like environment. backed by RDS
            rds:
                type: db.t2.medium
                engine: MySQL
                version: '5.7'
                storage: 12 # GB
                backup-retention: 2 # days
            ext:
                size: 30 # GB
        continuumtest:
            description: production-like environment.
            rds:
                type: db.t2.small
                engine: MySQL
                version: '5.7'
                storage: 12 # GB
                backup-retention: 2 # days
            ext:
                size: 30 # GB
        prod:
            description: production environment. backed by RDS
            rds:
                type: db.t2.medium
                engine: MySQL
                version: '5.7'
                multi-az: true
                storage: 24 # GB
            ext:
                size: 30 # GB
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1241: 80
        ram: 2048


elife-dashboard:
    subdomain: ppp-dash # ppp-dash.elifesciences.org
    repo: https://github.com/elifesciences/elife-dashboard
    formula-repo: https://github.com/elifesciences/elife-dashboard-formula
    default-branch: develop
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 80 # dashboard
            - 443 # dashboard
            - 8081 # dashboard_2
            - 8082 # dashboard_2
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        end2end:
            description: production-like environment. backed by RDS
            rds:
                storage: 5
                backup-retention: 2 # days
            sqs:
                # legacy custom name
                end2end-event-property-incoming-queue:
                    subscriptions:
                        - elife-bot-event-property--end2end
        continuumtest:
            sqs:
                # legacy custom name
                ct-event-property-incoming-queue:
                    subscriptions:
                        - elife-bot-event-property--continuumtest
        prod:
            description: production environment. backed by RDS
            rds:
                storage: 5
                multi-az: true
            sqs:
                # legacy custom name
                event-property-incoming-queue:
                    subscriptions:
                        - elife-bot-event-property--prod
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1324: 80
            8080: 8080 # scheduler (blocked on AWS)
        ram: 2048


# legacy API, do not use nor upgrade
elife-api:
    subdomain: api # api.elifesciences.org
    repo: https://github.com/elifesciences/elife-api
    formula-repo: https://github.com/elifesciences/elife-api-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 80
            - 443
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1233: 80


elife-reporting:
    formula-repo: https://github.com/elifesciences/elife-reporting-formula
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 1024
        ports:
            1333: 80

elife-libraries:
    domain: false
    subdomain: libraries
    formula-repo: https://github.com/elifesciences/elife-libraries-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.small # 2GB of RAM
        ports:
            - 22
        ext:
            size: 30 # GB
            type: gp2
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        load:
            description: running load tests
            type: t2.2xlarge
        spectrum:
            description: running end2end tests
            # 2 core, 8 GB of memory
            type: t2.medium
            ext:
                size: 10 # GB
        powerful:
            description: speeding up bot-lax-adaptor tests
            type: c4.2xlarge
        powerful2:
            description: speeding up bot-lax-adaptor tests even more
            type: c4.4xlarge
        powerful3:
            description: speeding up bot-lax-adaptor tests even more
            type: c4.8xlarge

    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 1024

containers:
    description: run any Docker-based workload
    subdomain: containers
    formula-repo: https://github.com/elifesciences/containers-formula
    aws:
        type: t2.medium # 4GB of RAM
        ports:
            - 22
        ext:
            size: 100 # GB
            type: gp2
    aws-alt:
        # AMIs created from here used in
        # https://alfred.elifesciences.org/configure
        # `Cloud` section
        jenkins-plugin-ami:
            ext: false
            ec2:
                root:
                    size: 100 # GB
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 1024

elife-alfred:
    subdomain: alfred
    formula-repo: https://github.com/elifesciences/elife-alfred-formula
    aws:
        type: t2.large
        ports:
            - 22
            - 80
            - 443
            - 10241 # JNLP for jenkins-cli.jar
            - 16022 # Jenkins SSH port
        ext:
            size: 100 # GB
            type: gp2
        s3:
            "{instance}-elife-alfred":
                deletion-policy: retain
    aws-alt:
        standalone:
            s3:
                "{instance}-elife-alfred":
                    deletion-policy: delete
        prod:
            subdomains:
                - alfred
                - ci--alfred # backward compatibility
    vagrant:
        ram: 4096
        ports:
            1433: 80

# used in https://alfred.elifesciences.org/configure
# `Cloud` section
elife-alfred-nodes:
    description: supports dynamic creation of EC2 instances from Jenkins
    domain: false
    intdomain: false
    aws:
        ec2:
            cluster-size: 0
            security-group:
                ports:
                    - 22
            

api-dummy:
    subdomain: api-dummy
    repo: https://github.com/elifesciences/api-dummy
    formula-repo: https://github.com/elifesciences/api-dummy-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.micro
        ports:
            - 22
            - 443
            - 80
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1242: 80

anonymous:
    description: a server without any eLife credentials; if you log in here, you will be using the anonymous separate AWS account
    formula-repo: https://github.com/elifesciences/anonymous-formula
    aws:
        type: t2.micro
        ports:
            - 22
    vagrant:
        ram: 1024

# used by "Maloney, Christopher (NIH/NLM/NCBI) [C]" <maloneyc@ncbi.nlm.nih.gov>
# this is a free form instance jats4r can do what they like with
# hosts http://jatswiki.org at the moment
jats4r:
    aws:
        ec2:
            ami: ami-c60b90d1 # us-east-1 xenial 16.04 LTS amd64 hvm:ebs-ssd 20160815 hvm
        type: t2.micro
        ports:
            - 22
            - 80
            - 443

# distinct from the 'jats4r' project, this runs an instance of the validator only
jats4r-validator:
    #domain: jats4r.org
    subdomain: validator # validator.jats4r.org
    repo: https://github.com/jats4r/validator
    formula-repo: https://github.com/elifesciences/jats4r-validator-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 80
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1239: 80


medium:
    description: microservice that gives access to eLife posts on Medium.com
    domain: false
    subdomain: medium
    repo: https://github.com/elifesciences/medium
    formula-repo: https://github.com/elifesciences/medium-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.micro
        ports:
            - 22
            - 80:
                cidr-ip: 10.0.0.0/16 # internal access only
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        clustered:
            ec2:
                cluster-size: 2
            elb:
                protocol: http
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 1024
        ports:
            1243: 80


bus:
    description: see https://github.com/elifesciences/bus
    default-branch: null
    domain: null
    intdomain: null
    aws:
        ec2: false
        sns:
            # bus-articles--prod, bus-articles--end2end, etc.
            - bus-articles--{instance}
            - bus-podcast-episodes--{instance}
            - bus-subjects--{instance}
            - bus-people--{instance}
            - bus-collections--{instance}
            - bus-events--{instance}
            - bus-interviews--{instance}
            - bus-blog-articles--{instance}
            - bus-annual-reports--{instance}
            - bus-covers--{instance}
            - bus-labs-posts--{instance}
            - bus-press-packages--{instance}
            - bus-metrics--{instance}
            - bus-profiles--{instance}
            - bus-digests--{instance}

search:
    domain: false
    subdomain: search
    repo: https://github.com/elifesciences/search
    formula-repo: https://github.com/elifesciences/search-formula
    formula-dependencies:
        - https://github.com/elifesciences/builder-base-formula
        - https://github.com/elifesciences/api-dummy-formula
    aws:
        type: t2.medium # 4 GB of RAM: once we know more about which software
                        # will be installed, we can choose the right machine
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 80:
                cidr-ip: 10.0.0.0/16 # internal access only
        sqs:
            # search--prod, search--end2end, etc.
            search--{instance}:
                subscriptions:
                    - bus-articles--{instance}
                    - bus-podcast-episodes--{instance}
                    - bus-subjects--{instance}
                    - bus-collections--{instance}
                    - bus-interviews--{instance}
                    - bus-blog-articles--{instance}
                    - bus-labs-posts--{instance}
    aws-alt:
        end2end:
            ports:
                - 22
                - 80:
                    cidr-ip: 10.0.0.0/16 # ELB only
                - 4730: # Gearman
                    cidr-ip: 10.0.0.0/16 # follower nodes
                - 9200: # ElasticSearch
                    cidr-ip: 10.0.0.0/16 # follower nodes
            ec2:
                cluster-size: 2
                dns-internal: True
            elb: 
                protocol: 
                    - http
        prod:
            ports:
                - 22
                - 80:
                    cidr-ip: 10.0.0.0/16 # ELB only
                - 4730: # Gearman
                    cidr-ip: 10.0.0.0/16 # follower nodes
                - 9200: # ElasticSearch
                    cidr-ip: 10.0.0.0/16 # follower nodes
            ec2:
                cluster-size: 2
                dns-internal: True
            elb: 
                protocol: 
                    - http
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048
        ports:
            1244: 80
            1245: 8080
            9920: 9200

recommendations:
    domain: false
    subdomain: recommendations
    repo: https://github.com/elifesciences/recommendations
    formula-repo: https://github.com/elifesciences/recommendations-formula
    formula-dependencies:
        - https://github.com/elifesciences/builder-base-formula
        - https://github.com/elifesciences/api-dummy-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.medium # 4 GB of RAM, same as search for now.
        ports:
            - 22
            - 80:
                cidr-ip: 10.0.0.0/16 # internal access only
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048
        ports:
            1254: 80

personalised-covers:
    subdomain: personalised-covers
    repo: https://github.com/elifesciences/personalised-covers
    formula-repo: https://github.com/elifesciences/personalised-covers-formula
    formula-dependencies:
        - https://github.com/elifesciences/builder-base-formula
        - https://github.com/elifesciences/api-dummy-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.micro # 1 GB of RAM: Unsure memory stats for PDF generation.
        ports:
            - 22
            - 80
            - 443
        s3:
            "{instance}-elife-personalised-covers":
                deletion-policy: retain
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
            s3:
                "{instance}-elife-personalised-covers":
                    deletion-policy: delete
        prod:
            subdomains:
                - covers
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 1024
        ports:
            1246: 80
            1247: 8080

schematron-validator:
    subdomain: schematron-validator
    default-branch: master
    repo: https://github.com/elifesciences/schematron-validator
    formula-repo: https://github.com/elifesciences/schematron-validator-formula
    formula-dependencies:
        - https://github.com/elifesciences/builder-base-formula
    aws:
        type: t2.small # Composer and Java need memory
        ports:
            - 22
            - 80
            - 443
    aws-alt:
        prod:
            subdomains:
                - schematron
    vagrant:
        ports:
            1246: 80
            1247: 8080

statusbase:
    subdomain: statusbase
    repo: https://github.com/ep320/statusbase
    formula-repo: https://github.com/elifesciences/statusbase-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        ports:
            - 22
            - 80
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1246: 80

observer:
    description: article-level reporting
    subdomain: observer # observer.elifesciences.org
    repo: https://github.com/elifesciences/observer
    formula-repo: https://github.com/elifesciences/observer-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.medium
        ports:
            - 22
            - 80
            - 8001
            - 443
        sqs:
            observer--{instance}:
                subscriptions:
                    - bus-articles--{instance}
                    - bus-press-packages--{instance}
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        standalone1404:
            rds:
                storage: 10
                backup-retention: 2 # days
                deletion-policy: Delete
        end2end:
            description: production-like environment. RDS backed
            rds:
                storage: 10
                backup-retention: 2 # days
        prod:
            description: production environment. RDS backed
            rds:
                storage: 10
                multi-az: true
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048 # metabase, mostly
        ports:
            1239: 80
            1240: 8001

error-pages:
    description: static deployment of https://github.com/elifesciences/error-pages
    default-branch: null
    domain: null
    intdomain: null
    aws:
        ec2: false
        s3:
            "{instance}-elife-error-pages":
                website-configuration:
                    index-document: index.html
                cors: true

figure-viewer:
    description: static deployment of https://github.com/elifesciences/figure-viewer
    default-branch: null
    domain: null
    intdomain: null
    aws:
        ec2: false
        s3:
            "{instance}-elife-figure-viewer":
                website-configuration:
                    index-document: index.html

peerscout:
    description: PeerScout
    subdomain: peerscout
    repo: https://github.com/elifesciences/peerscout
    formula-repo: https://github.com/elifesciences/peerscout-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.xlarge # explicitly 16GB RAM for heavy background processing
        ports:
            - 22
            - 80
            - 443
        ext:
            # external hdd
            size: 20 # GB
            device: /dev/sdf
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        end2end:
            rds:
                storage: 5
                backup-retention: 2 # days
            ext:
                # external hdd
                size: 100 # GB
                device: /dev/sdf
        prod:
            rds:
                storage: 5
                multi-az: true
            ext:
                # external hdd
                size: 100 # GB
                device: /dev/sdf
            subdomains:
                - peerscout
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1241: 80
        ram: 4096

sciencebeam-texture:
    description: Sciencebeam and Texture proof of concept
    subdomain: sciencebeam-texture
    repo: https://github.com/elifesciences/sciencebeam-texture
    formula-repo: https://github.com/elifesciences/sciencebeam-texture-formula
    aws:
        type: t2.medium # 4 GB RAM
        ports:
            - 22
            - 80 # texture
            - 443 # texture
        ext:
            size: 10 # GB
    aws-alt:
        demo:
            subdomains:
                - sciencebeam-texture
    vagrant:
        ports:
            1222: 80
        ram: 2048

iiif:
    description: IIIF, image server for resizing/tiling/zooming
    subdomain: iiif
    intdomain: null
    repo: https://github.com/elifesciences/loris
    formula-repo: https://github.com/elifesciences/iiif-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.medium
        ports:
            - 22
            - 80
            - 443
        fastly:
            subdomains:
                - "{instance}--cdn-iiif"
            gcslogging:
                bucket: "{instance}-elife-fastly"
                path: "iiif--{instance}/"
                period: 600
            bigquerylogging:
                project: "elife-fastly"
                dataset: "{instance}"
                table: "iiif"
            healthcheck:
                path: /ping-fastly
                check-interval: 10000
                timeout: 2000
            surrogate-keys:
                article-id-versioned:
                    url: "^/lax[:/]([0-9]+)(?:/|%2F)elife-(?:[a-z0-9-]+)-v([0-9]+)\\.(?:.+)$"
                    value: "article/\\1 article/\\1v\\2"
                    samples:
                        figure:
                            path: /lax:10627/elife-10627-fig1-v1.tif/full/1500,/0/default.jpg
                            expected: "article/10627 article/10627v1"
                        article-figure-supplement:
                            path: /lax:00666/elife-00666-fig2-figsupp1-v1.tif
                            expected: "article/00666 article/00666v1"
                        appendix-figure-supplement:
                            path: /lax:18215/elife-18215-app2-fig1-figsupp2-v2.tif
                            expected: "article/18215 article/18215v2"
                        encoded-urls:
                            path: /lax/18215%2Felife-18215-app2-fig1-figsupp2-v2.tif
                            expected: "article/18215 article/18215v2"
                article-id-unversioned:
                    url: "^/lax[:/]([0-9]+)(?:/|%2F)elife-(?:[a-z-0-9]+)-(?:video|media)(?:[0-9]+)\\.(?:.+)$"
                    value: "article/\\1 article/\\1/videos"
                    samples:
                        video-still:
                            path: /lax:34773/elife-34773-video2.jpg/full/639,/0/default.jpg
                            expected: "article/34773 article/34773/videos"
                        another-video-still:
                            path: /lax:07398/elife-07398-media1.jpg
                            expected: "article/07398 article/07398/videos"
                        article-figure-video-still:
                            path: /lax:26866/elife-26866-fig3-video1.jpg
                            expected: "article/26866 article/26866/videos"
                        encoded-urls:
                            path: /lax/26866%2Felife-26866-fig3-video1.jpg
                            expected: "article/26866 article/26866/videos"
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
            fastly: false
        # for testing new versions
        ci:
            ports:
                - 22
                - 80:
                    cidr-ip: 10.0.0.0/16 # ELB only
            ec2:
                #suppressed: [2]
                overrides:
                    1:
                        ext:
                            type: gp2
                    2:
                        ext:
                            type: gp2
                cluster-size: 4
            ext:
                size: 30 # GB
            elb:
                protocol: 
                    - https
                healthcheck:
                    path: /
            fastly: false
        end2end:
            ports:
                - 22
                - 80:
                    cidr-ip: 10.0.0.0/16 # ELB only
            ec2:
                cluster-size: 2
                #suppressed: [1]
            ext:
                size: 30 # GB
            elb:
                protocol: 
                    - https
                healthcheck:
                    path: /
        # manual tests
        continuumtest:
            ports:
                - 22
                - 80:
                    cidr-ip: 10.0.0.0/16 # ELB only
            ec2:
                cluster-size: 2
            elb:
                protocol: 
                    - https
                healthcheck:
                    path: /
            fastly:
                bigquerylogging:
                    dataset: "staging"
                gcslogging:
                    bucket: staging-elife-fastly
        prod:
            ports:
                - 22
                - 80:
                    cidr-ip: 10.0.0.0/16 # ELB only
            ec2:
                cluster-size: 3
            ext:
                size: 30 # GB
            elb:
                protocol: 
                    - https
                healthcheck:
                    path: /
            fastly:
                subdomains:
                    - "{instance}--cdn-iiif"
                    - iiif
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1261: 80

redirects:
    description: redirect various domains to the canonical elifesciences.org
    subdomain: redirects
    intdomain: null
    formula-repo: https://github.com/elifesciences/redirects-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.nano
        ports:
            - 22
            - 80
            - 443
    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
        prod:
            cloudfront:
                # arn:aws:iam::512686554592:server-certificate/cloudfront/redirects/redirects-2018
                certificate_id: ASCAIM46DMZL26YCYELLY
                subdomains:
                    - elifesciences.net
                    - e-lifesciences.org
                    - e-lifesciences.net
                    - elifejournal.net
                    - e-lifejournal.org
                    - e-lifejournal.com
                    - e-lifejournal.net
                    - elifejournal.org
                headers:
                    - Host

    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ports:
            1262: 80

profiles:
    subdomain: profiles
    repo: https://github.com/elifesciences/profiles
    formula-repo: https://github.com/elifesciences/profiles-formula
    aws:
        ports:
            - 22
            - 80
            - 443
    aws-alt:
        end2end:
            rds:
                engine: postgres
                storage: 5 # GB
                backup-retention: 2 # days
            ports:
                - 22
                - 80
                - 443
                - 8081 # orcid-dummy http
                - 8082 # orcid-dummy https
        prod:
            rds:
                engine: postgres
                storage: 5 # GB
                multi-az: true
    vagrant:
        ram: 1024
        ports:
            1265: 80

annotations:
    description: microservice that gives access to eLife annotations on Hypothes.is
    domain: false
    subdomain: annotations
    repo: https://github.com/elifesciences/annotations
    formula-repo: https://github.com/elifesciences/annotations-formula
    aws:
        type: t2.small
        ports:
            - 22
            - 80:
                cidr-ip: 10.0.0.0/16 # internal access only
        sqs:
            annotations--{instance}:
                subscriptions:
                    - bus-profiles--{instance}
    aws-alt:
        prod:
            s3:
                "{instance}-elife-annotations-hypothesis-emails":
                    # bucket policy http://docs.aws.amazon.com/ses/latest/DeveloperGuide/receiving-email-permissions.html#receiving-email-permissions-s3 has been added
    vagrant:
        ram: 1024
        ports:
            1248: 80

digests:
    subdomain: digests
    domain: false
    repo: https://github.com/elifesciences/digests
    formula-repo: https://github.com/elifesciences/digests-formula
    aws:
        ports:
            - 22
            - 80:
                cidr-ip: 10.0.0.0/16 # access via VPC ip range only
    aws-alt:
        end2end:
            rds:
                engine: postgres
                type: db.t2.micro
                storage: 5 # GB
                storage-type: gp2
                backup-retention: 2 # days
        continuumtest:
            rds:
                engine: postgres
                type: db.t2.micro
                storage: 5 # GB
                storage-type: gp2
                backup-retention: 2 # days
        prod:
            rds:
                engine: postgres
                type: db.t2.micro
                storage: 5 # GB
                storage-type: gp2
                multi-az: true
    vagrant:
        ram: 1024
        ports:
            1290: 80

evanthia-simpler-component:
    subdomain: evanthia-simpler-component
    repo: https://github.com/code56/nodeServerSimplerFig
    formula-repo: https://github.com/code56/simpler-component-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.small
        ports:
            - 22
    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048
        ports:
            1340: 80

crm:
    subdomain: crm # crm.elifesciences.org
    repo: https://github.com/elifesciences/drupal-civi
    formula-repo: git@github.com:elifesciences/crm-formula
    aws:
        ec2:
            ami: ami-92002785 # Ubuntu 14.04, deprecated
        type: t2.medium
        ports:
            22: 22
            80: 80
            443: 443
            30639: 30649 # civinky

    aws-alt:
        standalone:
            # for now a copy of standalone1404
            # required by masterless module
            description: isolated from the master-server and uses (deprecated) Ubuntu 14.04 (Trusty)
            ec2:
                ami: ami-92002785 # Ubuntu 14.04, deprecated
                masterless: true
            rds:
                backup-retention: 2 # days
                engine: MySQL
                version: '5.5'
                storage: 30 # GB
                type: db.t2.medium
                params:
                    log_bin_trust_function_creators: 1
                deletion-policy: Delete
        ci:
            rds:
                backup-retention: 2 # days
                engine: MySQL
                version: '5.5'
                storage: 30 # GB
                type: db.t2.medium
                params:
                    log_bin_trust_function_creators: 1
                deletion-policy: Delete

        end2end:
            rds:
                engine: MySQL
                version: '5.5'
                storage: 30 # GB
                type: db.t2.medium
                params:
                    log_bin_trust_function_creators: 1

        prod:
            rds:
                engine: MySQL
                version: '5.5'
                storage: 30 # GB
                type: db.t2.medium
                params:
                    log_bin_trust_function_creators: 1
            ext:
                size: 50 # GB

    vagrant:
        box: ubuntu/trusty64 # Ubuntu 14.04, deprecated
        ram: 2048
        ports:
            1237: 80

elife-xpub:
    subdomain: xpub
    repo: https://github.com/elifesciences/elife-xpub
    formula-repo: git@github.com:elifesciences/elife-xpub-formula
    aws:
        type: t2.medium
        ports:
            - 22
            - 80
            - 443
        ext:
            # external hdd
            size: 20 # GB
            device: /dev/sdh
            type: gp2
    aws-alt:
        ci:
            s3:
                "{instance}-elife-xpub-styleguide":
                    public: true
        end2end:
            s3:
                "{instance}-elife-xpub":
                    encryption: arn:aws:kms:us-east-1:512686554592:key/b6f44e77-46d8-41bb-a2e5-75c0588a2b20 
            rds:
                engine: postgres # or 'MySQL'
                version: '10.4'
                type: db.t2.small
                storage: 5 # GB
                storage-type: gp2
                backup-retention: 2 # days
                encryption: arn:aws:kms:us-east-1:512686554592:key/b626157a-1e5b-4bf6-8799-211505efe072 
            ec2:
                cluster-size: 2
            elb:
                protocol:
                    - 443
        staging:
            s3:
                "{instance}-elife-xpub":
                    encryption: arn:aws:kms:us-east-1:512686554592:key/b6f44e77-46d8-41bb-a2e5-75c0588a2b20 
            rds:
                engine: postgres # or 'MySQL'
                version: '10.4'
                type: db.t2.small
                storage: 5 # GB
                storage-type: gp2
                backup-retention: 2 # days
                encryption: arn:aws:kms:us-east-1:512686554592:key/b626157a-1e5b-4bf6-8799-211505efe072 
            ec2:
                cluster-size: 2
            elb:
                protocol:
                    - 443
        prod:
            subdomains:
                - xpub
            s3:
                "{instance}-elife-xpub":
                    deletion-policy: retain
                    encryption: arn:aws:kms:us-east-1:512686554592:key/b6f44e77-46d8-41bb-a2e5-75c0588a2b20 
            rds:
                multi-az: true
                engine: postgres # or 'MySQL'
                version: '10.4'
                type: db.t2.small
                storage: 5 # GB
                storage-type: gp2
                backup-retention: 28 # days
                encryption: arn:aws:kms:us-east-1:512686554592:key/b626157a-1e5b-4bf6-8799-211505efe072 
                deletion-policy: Snapshot
            ec2:
                cluster-size: 2
            elb:
                protocol:
                    - 443
    vagrant:
        ram: 2048
        ports:
            1201: 80

elife-ink:
    subdomain: ink
    repo: git@github.com:elifesciences/elife-ink
    formula-repo: git@github.com:elifesciences/elife-ink-formula
    aws:
        type: t2.medium
        ports:
            - 22
            - 443 # ink
            - 3000 # ink
            - 4567 # slanger
            - 4569 # slanger nginx https
            - 8080 # slanger api
            - 8082 # slanger api nginx https
    vagrant:
        ram: 4096
        ports:
            1223: 80


task-adept:
    description: production data dumps from TaskAdept
    default-branch: null
    domain: null
    intdomain: null
    aws:
        ec2: false
        s3:
            "{instance}-elife-task-adept":

exeter-adapter:
    description: Exeter history API integration
    domain: false
    intdomain: False
    aws:
        ec2: false
        sqs:
            exeter-adapter--{instance}: {}
    aws-alt:
        fresh:
            ec2: false
        1604:
            ec2: false
        1404:
            ec2: false
        standalone1604:
            ec2: false
        standalone1404:
            ec2: false
        standalone:
            ec2: false
        continuumtest:
            sqs:
                exeter-adapter--{instance}:
                    subscriptions:
                        - elife-bot-event-property--continuumtest
        prod:
            sqs:
                exeter-adapter--{instance}:
                    subscriptions:
                        - elife-bot-event-property--prod

fastly-logs:
    description: Fastly CDN access logs
    domain: false
    intdomain: false
    aws:
        ec2: false
        gcs:
            "{instance}-elife-fastly":
                project: elife-fastly
    gcp:
        bigquery:
            "{instance}":
                project: elife-fastly
                tables:
                    api_gateway:
                        schema: ./src/buildercore/bigquery/schemas/fastly-logs-201809.json
                    generic_cdn:
                        schema: ./src/buildercore/bigquery/schemas/fastly-logs-201809.json
                    journal:
                        schema: ./src/buildercore/bigquery/schemas/fastly-logs-201809.json
                    iiif:
                        schema: ./src/buildercore/bigquery/schemas/fastly-logs-201809.json
    aws-alt: {}

data-pipeline:
    description: Data consolidation project
    subdomain: pipeline
    formula-repo: https://github.com/elifesciences/data-pipeline-formula
    aws:
        ec2:
            ami: ami-1d4e7a66 # 16.04
        ext:
            size: 100 # GB
        type: t2.medium
        ports:
            - 22
            - 80 # used only to upgrade to https
            - 443
        s3:
            "{instance}-elife-data-pipeline":
                 deletion-policy: delete
            "{instance}-elife-data-pipeline-archive":
                 deletion-policy: retain
    gcp:
        bigquery:
            "{instance}": # dataset
                # does 'project' belong beneath dataset? do we want an instance affecting multiple projects?
                project: elife-data-pipeline
                tables:
                    # bit of repetition here
                    380_datascience_early_career_researchers:
                        schema: https://github.com/elifesciences/data-pipeline/schemas/380_datascience_early_career_researchers.json
                    489_datascience_editor_keywords:
                        schema: https://github.com/elifesciences/data-pipeline/schemas/489_datascience_editor_keywords.json
                    455_datascience_editors:
                        schema: https://github.com/elifesciences/data-pipeline/schemas/455_datascience_editors.json
    vagrant:
        box: bento/ubuntu-16.04
        cpus: 2
        ram: 2048
        ports:
            1222: 80


# deprecated, remove once all nifi-demo instances are destroyed
nifi-demo:
    formula-repo: https://github.com/elifesciences/nifi-demo-formula
    subdomain: nifidemo
    aws:
        ec2:
            ami: ami-1d4e7a66
            masterless: True
        ports:
            - 22
            - 443
    vagrant:
        cpus: 2
        ram: 2048
        ports:
            1222: 8080
